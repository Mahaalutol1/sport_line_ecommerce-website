<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Purchase Order</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        :root{
            --bg-body:#181818;
            --bg-card:#23272f;
            --accent:#4e4ffa;
            --accent-hover:#3737d6;
            --text-main:#f5f5f5;
            --text-muted:#bfc9e0;
            --border:#333;
        }
        body{
            margin:0;
            padding:0;
            background:var(--bg-body);
            color:var(--text-main);
            font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
            line-height:1.6;
        }
        .container{
            max-width:1200px;
            margin:3rem auto;
            background:var(--bg-card);
            padding:2.5rem 2rem;
            border-radius:12px;
            box-shadow:0 4px 24px rgba(0,0,0,0.18);
        }
        .page-header{
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom:2rem;
            flex-wrap:wrap;
            gap:1rem;
        }
        .page-title{
            margin:0;
            color:var(--accent);
            font-size:2rem;
        }
        .btn{
            display:inline-flex;
            align-items:center;
            gap:.5rem;
            padding:.6rem 1.2rem;
            border:none;
            border-radius:6px;
            cursor:pointer;
            text-decoration:none;
            font-weight:500;
            transition:background .2s;
            font-size:1rem;
        }
        .btn i{margin:0;}
        .btn-primary{background:var(--accent);color:#fff;}
        .btn-primary:hover{background:var(--accent-hover);}
        .btn-secondary{background:var(--border);color:#fff;}
        .btn-secondary:hover{background:#222;}
        .btn-add-item{background:#28a745;color:#fff;}
        .btn-add-item:hover{background:#1e7a38;}
        .btn-remove{background:#dc3545;color:#fff;}
        .btn-remove:hover{background:#b02a37;}
        .form-group{margin-bottom:1.5rem;}
        label{
            display:block;
            margin-bottom:.5rem;
            font-weight:500;
            color:var(--text-muted);
        }
        select,input{
            width:100%;
            padding:.6rem;
            border:1px solid var(--border);
            border-radius:6px;
            background:var(--bg-body);
            color:var(--text-main);
            font-size:1rem;
            transition:border-color .2s;
        }
        select:focus,input:focus{
            outline:none;
            border-color:var(--accent);
        }
        .items-container h3{margin-bottom:1rem;color:var(--text-main);}
        .item-row{
            display:grid;
            grid-template-columns:2fr 1fr 1fr 1fr auto;
            gap:1rem;
            align-items:center;
            padding:1rem;
            background:#1f1f1f;
            border-radius:6px;
            margin-bottom:1rem;
        }
        .total-section{
            margin-top:2rem;
            padding:1rem;
            background:#1f1f1f;
            border-radius:6px;
        }
        .total-row{
            display:flex;
            justify-content:space-between;
            font-weight:500;
            margin-bottom:.5rem;
        }
        .grand-total{
            font-size:1.2rem;
            font-weight:bold;
            color:var(--accent);
        }
        .alert{
            padding:1rem;
            border-radius:6px;
            margin-bottom:1rem;
        }
        .alert-success{background:#1e4620;border:1px solid #2e7d32;color:#a5d6a7;}
        .alert-error{background:#53202c;border:1px solid #c62828;color:#ef9a9a;}
        .order-info{
            background:#1f1f1f;
            padding:1rem;
            border-radius:6px;
            margin-bottom:2rem;
        }
        .order-info p{margin:.5rem 0;}
        .order-info strong{color:var(--text-main);}
    </style>
</head>
<body>
    <div class="container">
        <div class="page-header">
            <h1 class="page-title">Edit Purchase Order #{{ order.purchase_order_id }}</h1>
            <div class="actions">
                {% if session.role == 'owner' %}
                <a href="{{ url_for('owner_dashboard') }}" class="btn btn-secondary">
                {% elif session.role == 'manager' %}
                <a href="{{ url_for('manager_dashboard') }}" class="btn btn-secondary">
                {% else %}
                <a href="{{ url_for('warehouse_dashboard') }}" class="btn btn-secondary">
                {% endif %}
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <form method="POST" id="purchaseOrderForm" onsubmit="return validateForm()">
            <div class="order-info">
                <p><strong>Order Date:</strong> {{ order.order_date if order.order_date else 'N/A' }}</p>
                <p><strong>Current Status:</strong> {{ order.status }}</p>
                <p><strong>Supplier:</strong> {{ order.supplier_name }}</p>
                <p><strong>Warehouse:</strong> {{ order.warehouse_name }}</p>
            </div>

            <div class="form-group">
                <label for="supplier_id">Supplier *</label>
                <select name="supplier_id" id="supplier_id" required>
                    <option value="">Select Supplier</option>
                    {% for supplier in suppliers %}
                        <option value="{{ supplier.supplier_id }}" 
                                {% if supplier.supplier_id == order.supplier_id %}selected{% endif %}>
                            {{ supplier.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="warehouse_id">Warehouse *</label>
                <select name="warehouse_id" id="warehouse_id" required>
                    <option value="">Select Warehouse</option>
                    {% for warehouse in warehouses %}
                        <option value="{{ warehouse.warehouse_id }}"
                                {% if warehouse.warehouse_id == order.warehouse_id %}selected{% endif %}>
                            {{ warehouse.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="expected_delivery_date">Expected Delivery Date *</label>
                <input type="date" name="expected_delivery_date" id="expected_delivery_date" required
                       value="{{ order.expected_delivery_date if order.expected_delivery_date else '' }}"
                       min="{{ now.strftime('%Y-%m-%d') }}">
            </div>

            <div class="form-group">
                <label for="status">Status *</label>
                <select name="status" id="status" required>
                    <option value="Pending" {% if order.status == 'Pending' %}selected{% endif %}>Pending</option>
                    <option value="Processing" {% if order.status == 'Processing' %}selected{% endif %}>Processing</option>
                    <option value="Completed" {% if order.status == 'Completed' %}selected{% endif %}>Completed</option>
                    <option value="Cancelled" {% if order.status == 'Cancelled' %}selected{% endif %}>Cancelled</option>
                </select>
            </div>

            <div class="items-container">
                <h3>Order Items</h3>
                <div id="itemsList">
                    {% for item in order_details %}
                    <div class="item-row">
                        <select name="items[]" required onchange="updatePrice(this)">
                            <option value="">Select Item</option>
                            {% for product in items %}
                                <option value="{{ product.item_id }}"
                                        data-price="{{ product.price }}"
                                        {% if product.item_id == item.product_id %}selected{% endif %}>
                                    {{ product.name }}
                                </option>
                            {% endfor %}
                        </select>
                        <input type="number" name="quantities[]" min="1" required 
                               placeholder="Quantity" value="{{ item.quantity }}"
                               onchange="updateTotal()">
                        <input type="number" name="prices[]" step="0.01" required 
                               placeholder="Price" value="{{ item.unit_price }}"
                               onchange="updateTotal()">
                        <span class="row-total">${{ (item.quantity * item.unit_price)|round(2) }}</span>
                        <button type="button" class="btn-remove" onclick="removeItemRow(this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn-add-item" onclick="addItemRow()">
                    <i class="fas fa-plus"></i> Add Item
                </button>
            </div>

            <div class="total-section">
                <div class="total-row">
                    <span>Subtotal:</span>
                    <span id="subtotal">$0.00</span>
                </div>
                <div class="total-row">
                    <span>Tax (10%):</span>
                    <span id="tax">$0.00</span>
                </div>
                <div class="total-row grand-total">
                    <span>Grand Total:</span>
                    <span id="grandTotal">$0.00</span>
                </div>
            </div>

            <div style="margin-top: 2rem; text-align: right;">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </form>
    </div>

    <script>
        const items = {{ items|tojson|safe }};
        let itemRows = Array.from(document.getElementsByClassName('item-row'));

        function addItemRow() {
            const itemsList = document.getElementById('itemsList');
            const row = document.createElement('div');
            row.className = 'item-row';
            row.innerHTML = `
                <select name="items[]" required onchange="updatePrice(this)">
                    <option value="">Select Item</option>
                    ${items.map(item => `
                        <option value="${item.item_id}" 
                                data-price="${item.price}">
                            ${item.name}
                        </option>
                    `).join('')}
                </select>
                <input type="number" name="quantities[]" min="1" required 
                       onchange="updateTotal()" placeholder="Quantity">
                <input type="number" name="prices[]" step="0.01" min="0" required 
                       onchange="updateTotal()" placeholder="Unit Price">
                <span class="row-total">$0.00</span>
                <button type="button" class="btn-remove" onclick="removeItemRow(this)">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            itemsList.appendChild(row);
            itemRows.push(row);
            updateTotal();
        }

        function removeItemRow(button) {
            const row = button.closest('.item-row');
            const index = itemRows.indexOf(row);
            if (index > -1) {
                itemRows.splice(index, 1);
            }
            row.remove();
            updateTotal();
        }

        function updatePrice(select) {
            const row = select.closest('.item-row');
            const priceInput = row.querySelector('input[name="prices[]"]');
            const option = select.options[select.selectedIndex];
            const price = option.getAttribute('data-price') || 0;
            priceInput.value = price;
            updateTotal();
        }

        function updateTotal() {
            let subtotal = 0;
            itemRows.forEach(row => {
                const quantity = parseFloat(row.querySelector('input[name="quantities[]"]').value) || 0;
                const price = parseFloat(row.querySelector('input[name="prices[]"]').value) || 0;
                const total = quantity * price;
                row.querySelector('.row-total').textContent = `$${total.toFixed(2)}`;
                subtotal += total;
            });

            const tax = subtotal * 0.1;
            const grandTotal = subtotal + tax;

            document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('tax').textContent = `$${tax.toFixed(2)}`;
            document.getElementById('grandTotal').textContent = `$${grandTotal.toFixed(2)}`;
        }

        // Initialize totals
        updateTotal();

        function validateForm() {
            if (itemRows.length === 0) {
                alert('Please add at least one item to the order.');
                return false;
            }
            
            const hasEmptyFields = itemRows.some(row => {
                const select = row.querySelector('select');
                const quantity = row.querySelector('input[name="quantities[]"]');
                const price = row.querySelector('input[name="prices[]"]');
                return !select.value || !quantity.value || !price.value;
            });
            
            if (hasEmptyFields) {
                alert('Please fill in all item details.');
                return false;
            }
            
            return true;
        }
    </script>
</body>
</html> 